#include "w25q64.h"

u16 W25Q_TYPE=W25Q64;


void W25Q_Delay_us(u32 t) {
	while(t--);
	return;
}

void W25Q_Init(void) 
{
	GPIO_InitTypeDef GPIO_InitStructure;
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA, ENABLE );
	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_4;  //SPI CS
 	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;  //??????
	GPIO_InitStructure.GPIO_Speed=GPIO_Speed_50MHz;
 	GPIO_Init(GPIOA, &GPIO_InitStructure);
 	GPIO_SetBits(GPIOA, GPIO_Pin_4);
	SPI1_Init();		   //???SPI
	SPI1_SetSpeed(SPI_BaudRatePrescaler_4);	//???18M??,????
	W25Q_TYPE=W25Q_ReadID();//??FLASH ID.
}  

//??W25Q??????
//BIT7  6   5   4   3   2   1   0
//SPR   RV  TB BP2 BP1 BP0 WEL BUSY
//SPR:??0,????????,??WP??
//TB,BP2,BP1,BP0:FLASH???????
//WEL:?????
//BUSY:????(1,?;0,??)
//??:0x00
u8 W25Q_ReadSR(void)   
{  
	u8 byte=0;   
	W25Q_CS=0;                            //????   
	SPI1_ReadWriteByte(W25X_ReadStatusReg);    //???????????    
	byte=SPI1_ReadWriteByte(0Xff);             //??????  
	W25Q_CS=1;                            //????     
	return byte;   
} 
//?W25Q?????
//??SPR,TB,BP2,BP1,BP0(bit 7,5,4,3,2)???!!!
void W25Q_Write_SR(u8 sr)   
{   
	W25Q_CS=0;                            //????   
	SPI1_ReadWriteByte(W25X_WriteStatusReg);   //???????????    
	SPI1_ReadWriteByte(sr);               //??????  
	W25Q_CS=1;                            //????     	      
}   
//W25Q???	
//?WEL??   
void W25Q_Write_Enable(void)   
{
	W25Q_CS=0;                            //????   
    SPI1_ReadWriteByte(W25X_WriteEnable);      //?????  
	W25Q_CS=1;                            //????     	      
} 
//W25Q???	
//?WEL??  
void W25Q_Write_Disable(void)   
{  
	W25Q_CS=0;                            //????   
    SPI1_ReadWriteByte(W25X_WriteDisable);     //???????    
	W25Q_CS=1;                            //????     	      
} 			    
//????ID W25X16?ID:0XEF14
u16 W25Q_ReadID(void)
{
	u16 Temp = 0;	  
	W25Q_CS=0;				    
	SPI1_ReadWriteByte(0x90);//????ID??	    
	SPI1_ReadWriteByte(0x00); 	    
	SPI1_ReadWriteByte(0x00); 	    
	SPI1_ReadWriteByte(0x00); 	 			   
	Temp|=SPI1_ReadWriteByte(0xFF)<<8;  
	Temp|=SPI1_ReadWriteByte(0xFF);	 
	W25Q_CS=1;				    
	return Temp;
}   		    
//??SPI FLASH  
//????????????????
//pBuffer:?????
//ReadAddr:???????(24bit)
//NumByteToRead:???????(??65535)
void W25Q_Read(u8* pBuffer,u32 ReadAddr,u16 NumByteToRead)   
{ 
 	u16 i;    												    
	W25Q_CS=0;                            //????   
    SPI1_ReadWriteByte(W25X_ReadData);         //??????   
    SPI1_ReadWriteByte((u8)((ReadAddr)>>16));  //??24bit??    
    SPI1_ReadWriteByte((u8)((ReadAddr)>>8));   
    SPI1_ReadWriteByte((u8)ReadAddr);   
    for(i=0;i<NumByteToRead;i++)
	{ 
        pBuffer[i]=SPI1_ReadWriteByte(0XFF);   //????  
    }
	W25Q_CS=1;                            //????     	      
}  
//SPI???(0~65535)?????256??????
//???????????256?????
//pBuffer:?????
//WriteAddr:???????(24bit)
//NumByteToWrite:???????(??256),???????????????!!!	 
void W25Q_Write_Page(u8* pBuffer,u32 WriteAddr,u16 NumByteToWrite)
{
 	u16 i;  
    W25Q_Write_Enable();                  //SET WEL 
	W25Q_CS=0;                            //????   
    SPI1_ReadWriteByte(W25X_PageProgram);      //??????   
    SPI1_ReadWriteByte((u8)((WriteAddr)>>16)); //??24bit??    
    SPI1_ReadWriteByte((u8)((WriteAddr)>>8));   
    SPI1_ReadWriteByte((u8)WriteAddr);   
    for(i=0;i<NumByteToWrite;i++)SPI1_ReadWriteByte(pBuffer[i]);//????  
	W25Q_CS=1;                            //???? 
	W25Q_Wait_Busy();					   //??????
} 
//????SPI FLASH 
//??????????????????0XFF,????0XFF?????????!
//???????? 
//????????????????,??????????!
//pBuffer:?????
//WriteAddr:???????(24bit)
//NumByteToWrite:???????(??65535)
//CHECK OK
void W25Q_Write_NoCheck(u8* pBuffer,u32 WriteAddr,u16 NumByteToWrite)   
{ 			 		 
	u16 pageremain;	   
	pageremain=256-WriteAddr%256; //????????		 	    
	if(NumByteToWrite<=pageremain)pageremain=NumByteToWrite;//???256???
	while(1)
	{	   
		W25Q_Write_Page(pBuffer,WriteAddr,pageremain);
		if(NumByteToWrite==pageremain)break;//?????
	 	else //NumByteToWrite>pageremain
		{
			pBuffer+=pageremain;
			WriteAddr+=pageremain;	

			NumByteToWrite-=pageremain;			  //???????????
			if(NumByteToWrite>256)pageremain=256; //??????256???
			else pageremain=NumByteToWrite; 	  //??256????
		}
	};	    
} 
//?SPI FLASH  
//????????????????
//????????!
//pBuffer:?????
//WriteAddr:???????(24bit)
//NumByteToWrite:???????(??65535)  		   
u8 W25Q_BUF[4096];
void W25Q_Write(u8* pBuffer,u32 WriteAddr,u16 NumByteToWrite)   
{ 
	u32 secpos;
	u16 secoff;
	u16 secremain;	   
 	u16 i;    

	secpos=WriteAddr/4096;//???? 0~511 for w25x16
	secoff=WriteAddr%4096;//???????
	secremain=4096-secoff;//????????   

	if(NumByteToWrite<=secremain)secremain=NumByteToWrite;//???4096???
	while(1) 
	{	
		W25Q_Read(W25Q_BUF,secpos*4096,4096);//?????????
		for(i=0;i<secremain;i++)//????
		{
			if(W25Q_BUF[secoff+i]!=0XFF)break;//????  	  
		}
		if(i<secremain)//????
		{
			W25Q_Erase_Sector(secpos);//??????
			for(i=0;i<secremain;i++)	   //??
			{
				W25Q_BUF[i+secoff]=pBuffer[i];	  
			}
			W25Q_Write_NoCheck(W25Q_BUF,secpos*4096,4096);//??????  

		}else W25Q_Write_NoCheck(pBuffer,WriteAddr,secremain);//???????,??????????. 				   
		if(NumByteToWrite==secremain)break;//?????
		else//?????
		{
			secpos++;//?????1
			secoff=0;//?????0 	 

		   	pBuffer+=secremain;  //????
			WriteAddr+=secremain;//?????	   
		   	NumByteToWrite-=secremain;				//?????
			if(NumByteToWrite>4096)secremain=4096;	//??????????
			else secremain=NumByteToWrite;			//??????????
		}	 
	};	 	 
}
//??????
//??????:
//W25X16:25s 
//W25X32:40s 
//W25X64:40s 
//??????...
void W25Q_Erase_Chip(void)   
{                                             
    W25Q_Write_Enable();                  //SET WEL 
    W25Q_Wait_Busy();   
  	W25Q_CS=0;                            //????   
    SPI1_ReadWriteByte(W25X_ChipErase);        //???????  
	W25Q_CS=1;                            //????     	      
	W25Q_Wait_Busy();   				   //????????
}   
//??????
//Dst_Addr:???? 0~511 for w25x16
//???????????:150ms
void W25Q_Erase_Sector(u32 Dst_Addr)   
{   
	//Dst_Addr*=4096;
    W25Q_Write_Enable();                  //SET WEL 	 
    W25Q_Wait_Busy();   
  	W25Q_CS=0;                            //????   
    SPI1_ReadWriteByte(W25X_SectorErase);      //???????? 
    SPI1_ReadWriteByte((u8)((Dst_Addr)>>16));  //??24bit??    
    SPI1_ReadWriteByte((u8)((Dst_Addr)>>8));   
    SPI1_ReadWriteByte((u8)Dst_Addr);  
	W25Q_CS=1;                            //????     	      
    W25Q_Wait_Busy();   				   //??????
}  
//????
void W25Q_Wait_Busy(void)   
{   
	while ((W25Q_ReadSR()&0x01)==0x01);   // ??BUSY???
}  
//??????
void W25Q_PowerDown(void)   
{ 
  	W25Q_CS=0;                            //????   
    SPI1_ReadWriteByte(W25X_PowerDown);        //??????  
	W25Q_CS=1;                            //????     	      
    W25Q_Delay_us(3);                               //??TPD  
}   
//??
void W25Q_WAKEUP(void)   
{  
  	W25Q_CS=0;                            //????   
    SPI1_ReadWriteByte(W25X_ReleasePowerDown);   //  send W25X_PowerDown command 0xAB    
	  W25Q_CS=1;                            //????     	      
    W25Q_Delay_us(3);                               //??TRES1
}   


SPI_InitTypeDef  SPI_InitStructure;

void SPI1_Init(void)
{
	GPIO_InitTypeDef GPIO_InitStructure;
  
	RCC_APB2PeriphClockCmd(	RCC_APB2Periph_GPIOA|RCC_APB2Periph_SPI1, ENABLE );	
 
	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_5 | GPIO_Pin_6 | GPIO_Pin_7;
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP;  //??????
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
	GPIO_Init(GPIOA, &GPIO_InitStructure);

 	GPIO_SetBits(GPIOA,GPIO_Pin_5|GPIO_Pin_6|GPIO_Pin_7);

	SPI_InitStructure.SPI_Direction = SPI_Direction_2Lines_FullDuplex;  //??SPI???????????:SPI??????????
	SPI_InitStructure.SPI_Mode = SPI_Mode_Master;		//??SPI????:????SPI
	SPI_InitStructure.SPI_DataSize = SPI_DataSize_8b;		//??SPI?????:SPI????8????
	SPI_InitStructure.SPI_CPOL = SPI_CPOL_High;		//??????????:?????
	SPI_InitStructure.SPI_CPHA = SPI_CPHA_2Edge;	//???????????
	SPI_InitStructure.SPI_NSS = SPI_NSS_Soft;		//NSS?????(NSS??)????(??SSI?)??:??NSS???SSI???
	SPI_InitStructure.SPI_BaudRatePrescaler = SPI_BaudRatePrescaler_256;		//??????????:????????256
	SPI_InitStructure.SPI_FirstBit = SPI_FirstBit_MSB;	//???????MSB???LSB???:?????MSB???
	SPI_InitStructure.SPI_CRCPolynomial = 7;	//CRC???????
	SPI_Init(SPI1, &SPI_InitStructure);  //??SPI_InitStruct???????????SPIx???
 
	SPI_Cmd(SPI1, ENABLE); //??SPI??
	
	SPI1_ReadWriteByte(0xff);//????		 
}   
//SPI ??????
//SpeedSet:
//SPI_BaudRatePrescaler_2   2??   (SPI 36M@sys 72M)
//SPI_BaudRatePrescaler_8   8??   (SPI 9M@sys 72M)
//SPI_BaudRatePrescaler_16  16??  (SPI 4.5M@sys 72M)
//SPI_BaudRatePrescaler_256 256?? (SPI 281.25K@sys 72M)
  
void SPI1_SetSpeed(u8 SpeedSet)
{
	SPI_InitStructure.SPI_BaudRatePrescaler = SpeedSet ;
  	SPI_Init(SPI1, &SPI_InitStructure);
	SPI_Cmd(SPI1,ENABLE);
} 

//SPIx ??????
//TxData:??????
//???:??????
u8 SPI1_ReadWriteByte(u8 TxData)
{		
	u8 retry=0;				 	
	while (SPI_I2S_GetFlagStatus(SPI1, SPI_I2S_FLAG_TXE) == RESET) //?????SPI???????:????????
		{
		retry++;
		if(retry>200)return 0;
		}			  
	SPI_I2S_SendData(SPI1, TxData); //????SPIx??????
	retry=0;

	while (SPI_I2S_GetFlagStatus(SPI1, SPI_I2S_FLAG_RXNE) == RESET)//?????SPI???????:?????????
		{
		retry++;
		if(retry>200)return 0;
		}	  						    
	return SPI_I2S_ReceiveData(SPI1); //????SPIx???????					    
}





